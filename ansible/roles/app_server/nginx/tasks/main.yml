---
- name: ensure nginx is at the latest version
  yum:
    name: nginx
    state: latest
  notify:
    - Start nginx
  become: yes

- firewalld:
    service: https
    permanent: yes
    state: enabled
  become: yes
- firewalld:
    service: http
    permanent: yes
    state: enabled
  become: yes

- file:
    path: /etc/nginx/sites-available
    state: directory
  become: yes
- file:
    path: /etc/nginx/sites-enabled
    state: directory
  become: yes

- name: Use our nginx.conf file
  copy:
    dest: /etc/nginx/nginx.conf
    src: default_nginx.conf
  notify: Reload nginx
  become: yes

- name: Generate sites-available
  template:
    dest: /etc/nginx/sites-available/{{ item.host }}
    src: "rails_http.j2"
  with_items: "{{ nginx_apps }}"
  notify: Reload nginx
  when: nginx_apps is defined
  become: yes

- name: Link sites enabled to sites-enabled
  file:
    dest: /etc/nginx/sites-enabled/{{ item.host }}
    src: /etc/nginx/sites-available/{{ item.host }}
    state: link
  notify: Reload nginx
  with_items: "{{ nginx_apps }}"
  when: nginx_apps is defined
  become: yes
