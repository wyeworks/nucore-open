name: Staging auto deployment

# When this action will be executed
on:
  workflow_run:
    workflows: [ "Run test suite" ]
    branches: [ master ]
    types:
      - completed
# TODO: remove below after implementing automated stage deployments
# on:
#   push:
#     branches:
#       - "*"

  # Allow manually triggering this workflow by visiting
  # https://github.com/tablexi/nucore-open/actions/workflows/nucore-auto-deploy-staging.yml
  # and clicking "Run Workflow"
  workflow_dispatch:

jobs:
  deploy-staging:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout to the branch
        uses: actions/checkout@v3

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: 2.7.5 # Not needed with a .ruby-version file
          bundler-cache: true # runs 'bundle install' and caches installed gems automatically

      # TODO: implement automated stage deployments
      # - uses: miloserdow/capistrano-deploy@v3
      #   with:
      #     target: staging
      #     deploy_key: ${{ secrets.DEPLOY_ENC_KEY }}
      #     enc_rsa_key_val: ${{ vars.DEPLOY_PRIVATE_KEY }}

