= form_tag facility_bulk_email_path, method: :post, id: "bulk_email_create" do
  = hidden_field_tag :format, :csv

  .results_header
    .span1.select_all_none= select_all_link(start_none: true)

    - if current_ability.can?(:deliver, BulkEmail)
      = safe_join(@searcher.search_params_as_hidden_fields)

      .span1.pull-right
        = submit_tag t("bulk_email.compose_mail"),
          data: { format: :html },
          class: "btn btn-primary js--bulk-email-submit-button js--bulk-email-compose-button"

    .span1.pull-right
      = submit_tag t("bulk_email.export"),
        data: { format: :csv },
        class: "btn btn-primary js--bulk-email-submit-button js--bulk-email-download-csv-button"

    .clear

  %table.table.table-striped.table-hover
    %thead
      %tr
        %th
        %th= User.human_attribute_name(:name)
        %th= User.human_attribute_name(:username)
        %th= User.human_attribute_name(:email)

    %tbody
      - @users.each do |user|
        %tr
          %td
            = check_box_tag "recipient_ids[]",
              user.id,
              true,
              class: "toggle js--bulk-email-recipient",
              id: "recipient_id_#{user.id}"

          %td
            = link_to user.full_name, facility_user_path(current_facility, user)
          %td= user.username
          %td= user.email
