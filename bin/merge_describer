#!/bin/sh
# A script to parse git log output and generate a list of PRs that have been merged.
# Useful for PR descriptions when merging in changes from nucore-open.
# This is also a dependency of the release_describer script.
#
# Usage:
# Compare your current branch to master:
# bin/merge_describer
#
# Compare your current branch to a tag:
# bin/merge_describer v2024-06-18

open_repo_url=https://github.com/wyeworks/nucore-open
target_branch=${1:-master}

pr_num() {
  echo "$1" | grep -oE "\(#[0-9]+\)$" | tr -d "(#)"
}

jira_num() {
  echo "$1" | grep -oE "\[[a-zA-Z]+-[0-9]+\]" | tr -d "[]"
}

commit_msg() {
  echo "$1" | sed -E 's/ *\(#[0-9]+\)$//' | sed -E 's#^\[.*\]##' | sed 's/^ //'
}

git_log() {
  # Only log the commit title
  git log --pretty=format:"%s" $1..
}

git_log $target_branch | while read line; do
  pr=$(pr_num "$line")

  # If there's no matching PR number we skip the commit
  if [ -z $pr ]; then
    continue
  fi

  ticket=$(jira_num "$line")

  message=$(commit_msg "$line")

  if [ ! -z $ticket ]; then
    prefix="* [$ticket]"
  else
    prefix="*"
  fi

  # Add a a link to the PR, either in nucore-open or the current repo:
  # If the PR number is greater than 4000, it's a nucore-open PR.
  if [[ $pr -gt 4000 ]]; then
    pr_ref="$open_repo_url/pull/$pr)"
  else
    pr_ref="(#$pr)"
  fi

  output="$prefix $message $pr_ref"

  echo "$output"
done | sort
